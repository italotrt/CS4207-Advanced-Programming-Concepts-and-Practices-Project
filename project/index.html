<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project block-chain</title>
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
  <body>
    <h1 id="header">Project block-chain</h1>
    <div>
      <div>
        <button id="getStudentsBtn">Get Students</button>
      </div>
        <div>
          <h2>Add Student</h2>

          <input type="text" id="studentName" placeholder="Student Name">
          <input type="text" id="studentId" placeholder="Student ID">

          <button id="addStudentBtn">Add Student</button>
        </div>

        <div>
          <h2>Add Mentor</h2>

          <input type="text" id="mentorName" placeholder="Mentor Name">

          <label for="mentorLanguage">Choose a programming language:</label>
          <select name="mentorLanguage" id="mentorLanguage">
            <option value="PHP">PHP</option>
            <option value="Python">Python</option>
            <option value="JS">JS</option>
            <option value="Java">Java</option>
          </select>

          <button id="addMentorBtn">Add Mentor</button>
        </div>
        <div>
          <h2>Add Student</h2>

          <input type="text" id="studentIdForMessage" placeholder="Student ID">
          <input type="text" id="Message" placeholder="Enter your message!">
          <label for="programmingLanguage">Choose a programming language:</label>
          <select name="programmingLanguage" id="programmingLanguage">
            <option value="PHP">PHP</option>
            <option value="Python">Python</option>
            <option value="JS">JS</option>
            <option value="Java">Java</option>
          </select>
          <button id="sendMessage">Send Message</button>
        </div>
        <div>
          <ul id="listOfMessages">
            <li>Item 1</li>
          </ul>
        </div>
    </div>
    

    <script>
      if (window.ethereum) {
        const web3 = new Web3(window.ethereum);
        window.ethereum.request({method: 'eth_requestAccounts'});

        const contractAddress = '0x177687C9F4A28f7B4950BA861742dAB17B949fb5';

        let smartContract;
        let pythonAnswers;
        let phpAnswers;
        let jsAnswers;
        let javaAnswers;

        async function initializeContract() {
          try {
            let response = await fetch('build/contracts/Chat.json');
            let jsonObject = await response.json();
            const contractABI = jsonObject['abi'];

            response = await fetch('../answers/python.json');
            jsonObject = await response.json();
            pythonAnswers = jsonObject['Answer'];

            response = await fetch('../answers/php.json');
            jsonObject = await response.json();
            phpAnswers = jsonObject['Answer'];

            response = await fetch('../answers/js.json');
            jsonObject = await response.json();
            jsAnswers = jsonObject['Answer'];

            response = await fetch('../answers/java.json');
            jsonObject = await response.json();
            javaAnswers = jsonObject['Answer'];

            smartContract = new web3.eth.Contract(contractABI, contractAddress);

            console.log('Contract methods:', smartContract.methods);

            document.getElementById('addStudentBtn').addEventListener('click', addStudent);
            document.getElementById('addMentorBtn').addEventListener('click', addMentor);
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('getStudentsBtn').addEventListener('click', getStudents);
          } catch (error) {
            console.error('Error loading contract ABI:', error);
          }
        }

        async function addStudent() {
          const studentName = document.getElementById('studentName').value;
          const studentId = document.getElementById('studentId').value;
          console.log('studentName:', studentName, 'studentId:', studentId);

          if (studentName && studentId) {
            try {
              const accounts = await web3.eth.getAccounts();
              console.log(accounts);
              await smartContract.methods.addStudent(studentName, studentId).send({from: accounts[0]});
              alert("Student added successfully!");
            } catch(error) {
              console.log(error)
            }
          } else {
            alert("Please enter a valid student name and ID.");
          }
        }

        async function addMentor() {
          const mentorName = document.getElementById('mentorLanguage').value;
          const mentorLanguage = document.getElementById('mentorName').value;
          console.log('MentorName:', mentorName, 'MentorLanguage:', mentorLanguage);

          if (mentorName && mentorLanguage) {
            const accounts = await web3.eth.getAccounts();
            console.log(accounts);
            tw = await smartContract.methods.addMentor(mentorName, mentorLanguage);
            tw.send({from: accounts[0]})
            alert("Mentor added successfully!");
          } else {
            alert("Please enter a valid Mentor name and programming language.");
          }
        }

        async function sendMessage() {
          const message = document.getElementById('Message').value;
          const programmingLanguage = document.getElementById('programmingLanguage').value;
          const studentId = document.getElementById('studentIdForMessage').value;
          console.log('Message:', message, 'Programming Language:', programmingLanguage, 'Student ID:', studentId);

          if(message && programmingLanguage && studentId) {
            const accounts = await web3.eth.getAccounts();
            tw = await smartContract.methods.sendMessage(message, programmingLanguage, studentId);
            await tw.send({from: accounts[0]}).on('receipt', receipt => {
                      console.log('Message sent:', receipt);
                      var firstname = document.getElementById('listOfMessages');
                      var entry = document.createElement('li');
                      entry.appendChild(document.createTextNode(message));
                      entry.id = uuidv4();
                      firstname.insertBefore(entry, firstname.firstChild);
                      setTimeout(() => {
                                getAnswer(programmingLanguage).then(answer => {
                                  createNestedList(message, answer, entry.id);
                                });
                            }, 3000);
                    });
            let locDocument = document;
            alert("Message sent successfully!");
          } else {
            alert("Please enter a valid message, programming language and student ID.");
          }
        }

        async function getStudents() {
          const students = await smartContract.methods.getStudentIds().call();
          console.log('Students:', students);
          alert('Students: ' + students.toString());
        }

        function updateHeader(headName) {
          document.getElementById('header').textContent = headName;
        }

        async function getAnswer(programmingLanguage) {
          switch(programmingLanguage) {
            case 'PHP':
              return phpAnswers[Math.floor(Math.random() * phpAnswers.length)];
            case 'Python':
              return pythonAnswers[Math.floor(Math.random() * pythonAnswers.length)];
            case 'JS':
              return jsAnswers[Math.floor(Math.random() * jsAnswers.length)];
            case 'Java':
              return javaAnswers[Math.floor(Math.random() * javaAnswers.length)];
            default:
              return 'No answer found!';
          }

        }

        function createNestedList(question, answer, id) {
            const mainList = document.getElementById(id);

            const nestedList = document.createElement('ul');
            const nestedItem1 = document.createElement('li');
            nestedItem1.textContent = `Answer : ${answer}`;
            
            nestedList.appendChild(nestedItem1);
            mainList.appendChild(nestedList);
        }

        function uuidv4() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
          .replace(/[xy]/g, function (c) {
              const r = Math.random() * 16 | 0, 
                  v = c == 'x' ? r : (r & 0x3 | 0x8);
              return v.toString(16);
          });
        }

        initializeContract();
      }
    </script>
  </body>
</html>